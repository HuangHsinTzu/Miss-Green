<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Miss Green</title>
    <link
      rel="icon"
      type="logoicon"
      href="static/resources/Miss Green Logo.ico"
    />
    <link rel="stylesheet" href="static/MissGreen.css" />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Sacramento&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none; /* 取消 WebKit 瀏覽器的原生樣式 */
        margin: 0; /* 去除边距 */
      }
      table input {
        text-align: center;
        width: 100px;
      }
      table button {
        font-size: 30px;
        font-weight: bolder;
      }
      .navbar-brand {
        color: #727d6b;
        font-weight: 1000;
        font-size: xx-large;
        font-family: "Sacramento", cursive;
      }
      .navbar-brand:hover {
        color: #727d6b;
        font-weight: 1000;
        font-size: xx-large;
        font-family: "Sacramento", cursive;
      }
      .navbar-brand:visited {
        color: #727d6b;
        font-weight: 1000;
        font-size: xx-large;
        font-family: "Sacramento", cursive;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      .page-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 100%; /* 让容器填满整个页面 */
      }
      main {
        flex: 1;
      }
      footer {
        margin-top: auto;
        width: 100%;
        margin-left: 200px;
      }
      form {
        margin: 20px;
      }
      .cartContent {
        margin: 20px;
        margin-top: 30px;
      }
      h4 {
        color: #727d6b;
        font-weight: 600;
        border-bottom: solid 1px #c2c2c2;
      }
      table {
        width: 100%;
        border-bottom: solid 1px #c2c2c2;
      }
      .Pay {
        color: white;
        background-color: #727d6b;
        cursor: pointer;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        float: right;
        width: 200px;
        outline: none;
        border: none;
      }
      label {
        margin: 10px;
        width: 90px;
      }
      .totalCostOnPage {
        text-align: right;
        font-size: larger;
        font-weight: 500;
        margin: 20px;
        margin-right: 30px;
      }
      button {
        background-color: transparent;
        color: #727d6b;
        text-align: center;
        border: none;
        border-radius: 0.5rem;
        width: 30px;
      }
      .modal-title {
        color: #727d6b;
        font-weight: 1000;
        font-size: xx-large;
        font-family: "Sacramento", cursive;
      }
      .checkbox {
        width: 15px;
        height: 15px;
      }
      th:first-child {
        width: 75px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <nav
      class="navbar navbar-expand-lg bg-body-tertiary sticky-top green-border-top"
    >
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Miss Green</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNavDropdown"
          aria-controls="navbarNavDropdown"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="/Items">商品總覽 | ALL ITEMS</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/ActivitiesRegistration"
                >農場活動 | Activities</a
              >
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                追蹤我們｜FOLLOW US
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a
                    class="dropdown-item"
                    href="https://www.instagram.com/"
                    target="_blank"
                    ><svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      fill="currentColor"
                      class="bi bi-instagram custom-icon-color"
                      viewBox="0 0 16 16"
                    >
                      <path
                        d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.9 3.9 0 0 0-1.417.923A3.9 3.9 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.9 3.9 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.9 3.9 0 0 0-.923-1.417A3.9 3.9 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599s.453.546.598.92c.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.5 2.5 0 0 1-.599.919c-.28.28-.546.453-.92.598-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.5 2.5 0 0 1-.92-.598 2.5 2.5 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233s.008-2.388.046-3.231c.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92s.546-.453.92-.598c.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92m-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217m0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334"
                      />
                    </svg>
                    Instagram</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="https://www.facebook.com/"
                    target="_blank"
                    ><svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      fill="currentColor"
                      class="bi bi-facebook custom-icon-color"
                      viewBox="0 0 16 16"
                    >
                      <path
                        d="M16 8.049c0-4.446-3.582-8.05-8-8.05C3.58 0-.002 3.603-.002 8.05c0 4.017 2.926 7.347 6.75 7.951v-5.625h-2.03V8.05H6.75V6.275c0-2.017 1.195-3.131 3.022-3.131.876 0 1.791.157 1.791.157v1.98h-1.009c-.993 0-1.303.621-1.303 1.258v1.51h2.218l-.354 2.326H9.25V16c3.824-.604 6.75-3.934 6.75-7.951"
                      />
                    </svg>
                    Facebook</a
                  >
                </li>
                <li>
                  <a
                    class="dropdown-item"
                    href="https://line.me/en/"
                    target="_blank"
                    ><svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      fill="currentColor"
                      class="bi bi-line custom-icon-color"
                      viewBox="0 0 16 16"
                    >
                      <path
                        d="M8 0c4.411 0 8 2.912 8 6.492 0 1.433-.555 2.723-1.715 3.994-1.678 1.932-5.431 4.285-6.285 4.645-.83.35-.734-.197-.696-.413l.003-.018.114-.685c.027-.204.055-.521-.026-.723-.09-.223-.444-.339-.704-.395C2.846 12.39 0 9.701 0 6.492 0 2.912 3.59 0 8 0M5.022 7.686H3.497V4.918a.156.156 0 0 0-.155-.156H2.78a.156.156 0 0 0-.156.156v3.486c0 .041.017.08.044.107v.001l.002.002.002.002a.15.15 0 0 0 .108.043h2.242c.086 0 .155-.07.155-.156v-.56a.156.156 0 0 0-.155-.157m.791-2.924a.156.156 0 0 0-.156.156v3.486c0 .086.07.155.156.155h.562c.086 0 .155-.07.155-.155V4.918a.156.156 0 0 0-.155-.156zm3.863 0a.156.156 0 0 0-.156.156v2.07L7.923 4.832l-.013-.015v-.001l-.01-.01-.003-.003-.011-.009h-.001L7.88 4.79l-.003-.002-.005-.003-.008-.005h-.002l-.003-.002-.01-.004-.004-.002-.01-.003h-.002l-.003-.001-.009-.002h-.006l-.003-.001h-.004l-.002-.001h-.574a.156.156 0 0 0-.156.155v3.486c0 .086.07.155.156.155h.56c.087 0 .157-.07.157-.155v-2.07l1.6 2.16a.2.2 0 0 0 .039.038l.001.001.01.006.004.002.008.004.007.003.005.002.01.003h.003a.2.2 0 0 0 .04.006h.56c.087 0 .157-.07.157-.155V4.918a.156.156 0 0 0-.156-.156zm3.815.717v-.56a.156.156 0 0 0-.155-.157h-2.242a.16.16 0 0 0-.108.044h-.001l-.001.002-.002.003a.16.16 0 0 0-.044.107v3.486c0 .041.017.08.044.107l.002.003.002.002a.16.16 0 0 0 .108.043h2.242c.086 0 .155-.07.155-.156v-.56a.156.156 0 0 0-.155-.157H11.81v-.589h1.525c.086 0 .155-.07.155-.156v-.56a.156.156 0 0 0-.155-.157H11.81v-.589h1.525c.086 0 .155-.07.155-.156Z"
                      />
                    </svg>
                    Line</a
                  >
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="23"
        height="23"
        fill="currentColor"
        class="bi bi-person custom-icon-color"
        viewBox="0 0 16 16"
        style="cursor: pointer"
      >
        <path
          d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z"
        />
      </svg>
      <svg
        width="20px"
        height="20px"
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        fill="currentColor"
        class="bi bi-cart custom-icon-color"
        viewBox="0 0 16 16"
        style="cursor: pointer"
        data-bs-toggle="offcanvas"
        href="#offcanvasExample"
        role="button"
        aria-controls="offcanvasExample"
      >
        <path
          d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5M3.102 4l1.313 7h8.17l1.313-7zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4m7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4m-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2m7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2"
        />
      </svg>
    </nav>
    <div
      class="offcanvas offcanvas-start"
      tabindex="-1"
      id="offcanvasExample"
      aria-labelledby="offcanvasExampleLabel"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasExampleLabel">
          今日加入購物車內容：
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="offcanvas"
          aria-label="Close"
        ></button>
      </div>
      <div class="scroll-body">
        <div id="offcanvas-body"></div>
      </div>
    </div>

    <div class="page-container">
      <main>
        <div class="cartContent">
          <h4>購物車</h4>
          <!-- 表格元素 -->
          <table id="cart-table">
            <!-- 表头 -->
            <thead>
              <tr>
                <th>
                  <input type="checkbox" class="checkbox" name="checkbox_all" />
                </th>
                <th>商品資料</th>
                <th>單價</th>
                <th>數量</th>
                <th>小計</th>
                <th>移除</th>
              </tr>
            </thead>
            <!-- 表格主体 -->
            <tbody>
              <!-- 这里的数据行将由 JavaScript 动态生成 -->
            </tbody>
          </table>
          <div class="totalCostOnPage"></div>
        </div>
        <form id="shipping-form">
          <label for="name">取貨人姓名:</label>
          <input type="text" id="name" name="name" required /><br />

          <label for="address">送貨地址:</label>
          <input type="text" id="address" name="address" required /><br />

          <label for="payment-method">付款方式:</label>
          <select id="payment-method" name="payment-method" required>
            <br />
            <option value="credit-card">信用卡</option>
            <br />
            <option value="paypal">LinePay</option>
            <option value="cash-on-delivery">貨到付款</option>
          </select>

          <button type="submit" class="Pay">結帳</button>
        </form>
      </main>
      <!-- Modal -->
      <div
        class="modal fade"
        id="exampleModal"
        tabindex="-1"
        aria-labelledby="exampleModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="exampleModalLabel">
                Miss Green
              </h1>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">感謝您的購買，我們會盡快幫您出貨！</div>
          </div>
        </div>
      </div>
      <footer
        class="row row-cols-1 row-cols-sm-2 row-cols-md-5 py-5 my-5 border-top"
      >
        <div class="col mb-3">
          <a
            href="/"
            class="d-flex align-items-center mb-3 link-body-emphasis text-decoration-none"
          >
            <img
              src="static/resources/專題提案_第1組__1_-removebg-preview.png"
              alt="Logo"
              width="100"
              height="100"
            />
            <svg class="bi me-2" width="40" height="32">
              <use xlink:href="#bootstrap" />
            </svg>
          </a>
          <p class="text-body-secondary">&copy; 2024</p>
        </div>

        <div class="col mb-2">
          <h5>INFO</h5>
          <ul class="nav flex-column">
            <li class="nav-item mb-2">
              <a href="#" class="nav-link p-0 text-body-secondary"
                >品牌故事 | Our Story</a
              >
            </li>
            <li class="nav-item mb-2">
              <a href="#" class="nav-link p-0 text-body-secondary"
                >訂購須知 | Orders</a
              >
            </li>
          </ul>
        </div>

        <div class="col mb-2">
          <h5>SERVICE TIME</h5>
          <ul class="nav flex-column">
            <li class="nav-item mb-2 service-time">Monday - Friday</li>
            <li class="nav-item mb-2 service-time">10:30 - 19:30</li>
          </ul>
        </div>

        <!--<div class="col mb-3">
            <h5>Section</h5>
            <ul class="nav flex-column">
              <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Home</a></li>
              <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Features</a></li>
              <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">Pricing</a></li>
              <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">FAQs</a></li>
              <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-body-secondary">About</a></li>
            </ul>
          </div>!-->
      </footer>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      // 獲取資料庫購物車的數據
      const cartItems = {{ items | tojson }};
      // 获取表格主体元素
      const cartBody = document.querySelector("#cart-table tbody");
      // 清空表格主体
      //cartBody.innerHTML = "";

      // 遍历购物车商品列表，为每个商品创建一行并填充数据
      cartItems.forEach(item => {
          // 创建一行
          const row = document.createElement("tr");
          row.id = `row-${item.id}`;

          // 创建复选框单元格
          const checkboxCell = document.createElement("td");
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.classList.add("checkbox");
          checkbox.setAttribute("product-id", item.id);
          checkbox.addEventListener("change", updateTotalCost);
          checkboxCell.appendChild(checkbox);
          row.appendChild(checkboxCell);

          // 商品名称单元格
          const nameCell = document.createElement("td");
          nameCell.textContent = item.name;
          row.appendChild(nameCell);

          // 单价单元格
          const pricePerUnitCell = document.createElement("td");
          pricePerUnitCell.textContent = `NT$${item.price}`;
          row.appendChild(pricePerUnitCell);

          // 数量单元格
          const quantityCell = document.createElement("td");
          const quantityInput = document.createElement("input");
          quantityInput.type = "number";
          quantityInput.value = 1;
          quantityInput.min = 1;
          quantityInput.addEventListener("input", function () {
              // 当数量输入框的值发生变化时，更新数量
              const newQuantity = parseInt(quantityInput.value);
              if (newQuantity >= 1) {
                  // 更新购物车中商品的数量
                  updateSubtotalAndTotal(row, item, subtotalCell);
              }
          });
          // 创建增加和减少数量的按钮
          const increaseButton = document.createElement("button");
          increaseButton.textContent = "+";
          increaseButton.addEventListener("click", function () {
              // 增加数量
              quantityInput.value++;
              updateSubtotalAndTotal(row, item, subtotalCell);
          });

          const decreaseButton = document.createElement("button");
          decreaseButton.textContent = "-";
          decreaseButton.addEventListener("click", function () {
              // 减少数量
              if (quantityInput.value > 1) {
                quantityInput.value--;
                updateSubtotalAndTotal(row, item, subtotalCell);
              }
          });
          quantityCell.appendChild(decreaseButton);
          quantityCell.appendChild(quantityInput);
          quantityCell.appendChild(increaseButton);
          row.appendChild(quantityCell);

          // 小计单元格
          const newQuantity = parseInt(quantityInput.value);
          const subtotalCell = document.createElement("td");
          const unitPrice = newQuantity * item.price;
          subtotalCell.textContent = `NT$${unitPrice}`;
          row.appendChild(subtotalCell);

          // 移除按钮单元格
          const deleteCell = document.createElement("td");
          const deleteButton = document.createElement("button");
          deleteButton.setAttribute("product-id", item.id); // 设置product-id属性
                deleteButton.setAttribute(
                  "onclick",
                  `removeFromCart(${item.id});`
                );
                deleteButton.innerHTML =
                  '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>';
          deleteCell.appendChild(deleteButton);
          row.appendChild(deleteCell);

          // 将行添加到表格主体中
          cartBody.appendChild(row);
      });

            // 页面加载时更新购物车显示
            const cart = getCartFromCookies();
            document.addEventListener("DOMContentLoaded", function () {
              console.log(document.cookie);
              //const cart = getCartFromCookies(); // 从 Cookie 中获取购物车数据
              updateCartUI(cart); // 更新购物车显示
              updateCartTable(cart);
              saveCartToDatabase();
            });

            // 定义函数：从Cookies中获取购物车数据
            function getCartFromCookies() {
              const cartCookie = document.cookie
                .split("; ")
                .find((row) => row.startsWith("cart="));
              if (cartCookie) {
                return JSON.parse(cartCookie.split("=")[1]);
              } else {
                return {};
              }
            }

            // 定义函数：更新购物车UI显示
            function updateCartUI(cart) {
              const offcanvasBody = document.getElementById("offcanvas-body");
              offcanvasBody.innerHTML = ""; // 清空当前购物车显示内容
              let totalPrice = 0; // 初始化总价为0

              for (const [product, details] of Object.entries(cart)) {
                console.log(details.price);
                console.log(details.quantity);
                const productTotal = details.price * details.quantity;
                const productInfoDiv = document.createElement("div");
                productInfoDiv.textContent = `${details.productName} * ${
                  details.quantity
                } - NT$${productTotal.toFixed(2)}`;
                offcanvasBody.appendChild(productInfoDiv);

                totalPrice += productTotal; // 累加总价
              }

              // 创建并添加总价显示
              const totalPriceDiv = document.createElement("div");
              totalPriceDiv.textContent = `總價: NT$${totalPrice.toFixed(2)}`;
              totalPriceDiv.style.fontWeight = "bold";
              totalPriceDiv.style.marginTop = "10px";
              offcanvasBody.appendChild(totalPriceDiv);
            }

            // 页面加载时执行以下函数
            function updateCartTable(cart) {
              // 获取用于显示购物车数据的元素
              const cartTable = document.getElementById("cart-table");
              const cartBody = cartTable.querySelector("tbody");
              const existingProductIds = new Set();

              // 遍历已有的购物车商品，收集商品 ID
              cartBody.querySelectorAll(".checkbox").forEach((checkbox) => {
                existingProductIds.add(checkbox.getAttribute("product-id"));
              });

              // 遍历 cart 数据
              for (const [product, details] of Object.entries(cart)) {
                // 检查商品是否已经存在于购物车中
                if (existingProductIds.has(details.productId)) {
                  continue; // 如果商品已存在，跳过该商品的添加步骤
                }

                // 创建一行
                const row = document.createElement("tr");
                row.id = `row-${details.productId}`;

                //創建checkbox，用product_id來辨認
                const checkboxCell = document.createElement("td");
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.classList.add("checkbox");
                checkbox.setAttribute("product-id", details.productId); // Add product_id attribute
                checkbox.addEventListener("change", updateTotalCost);
                checkboxCell.appendChild(checkbox);
                row.appendChild(checkboxCell);

                // 商品名称
                const nameCell = document.createElement("td");
                nameCell.textContent = details.productName;
                row.appendChild(nameCell);

                // 单价价格
                const pricePerUnitCell = document.createElement("td");
                pricePerUnitCell.textContent = `NT$${details.price}`;
                row.appendChild(pricePerUnitCell);

                // 数量单元格
                const quantityCell = document.createElement("td");

                // 创建数量输入框
                const quantityInput = document.createElement("input");
                quantityInput.type = "number";
                quantityInput.value = details.quantity;
                quantityInput.min = 1;
                quantityInput.addEventListener("input", function () {
                  // 当数量输入框的值发生变化时，更新数量
                  const newQuantity = parseInt(quantityInput.value);
                  if (newQuantity >= 1) {
                    details.quantity = newQuantity;
                    updateSubtotalAndTotal(row, details, index);
                  }
                });

                // 创建增加和减少数量的按钮
                const increaseButton = document.createElement("button");
                increaseButton.textContent = "+";
                increaseButton.addEventListener("click", function () {
                  // 增加数量
                  details.quantity++;
                  quantityInput.value = details.quantity;
                  updateSubtotalAndTotal(row, details, subtotalCell);
                });

                const decreaseButton = document.createElement("button");
                decreaseButton.textContent = "-";
                decreaseButton.addEventListener("click", function () {
                  // 减少数量
                  if (details.quantity > 1) {
                    details.quantity--;
                    quantityInput.value = details.quantity;
                    updateSubtotalAndTotal(row, details, subtotalCell);
                  }
                });

                // 将按钮和数量输入框添加到数量单元格中
                quantityCell.appendChild(decreaseButton);
                quantityCell.appendChild(quantityInput);
                quantityCell.appendChild(increaseButton);

                // 将数量单元格添加到行中
                row.appendChild(quantityCell);

                // 小计（单价 * 数量）
                const newQuantity = parseInt(quantityInput.value);
                const subtotalCell = document.createElement("td");
                const unitPrice = details.price * newQuantity;
                console.log(unitPrice);
                subtotalCell.textContent = `NT$${unitPrice}`;
                row.appendChild(subtotalCell);

                // 移除購物車按钮
                const deleteCell = document.createElement("td");
                const deleteButton = document.createElement("button");
                deleteButton.setAttribute("product-id", details.productId); // 设置product-id属性
                deleteButton.setAttribute(
                  "onclick",
                  `removeFromCart(${details.productId});`
                );
                deleteButton.innerHTML =
                  '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>';
                deleteCell.appendChild(deleteButton);
                row.appendChild(deleteCell);

                // 将新商品的 ID 添加到已收集的商品 ID 中
                existingProductIds.add(details.productId);
                // 将行添加到表格主体
                cartBody.appendChild(row);
              }


            }

            // 更新小计和总价
            function updateSubtotalAndTotal(row, details, subtotalCell) {
              // 更新小计单元格
              const unitPrice = details.quantity * details.price;
              subtotalCell.textContent = `NT$${unitPrice}`;

              // 更新总价
              updateTotalCost();
            }

            // 更新总价的函数
            function updateTotalCost() {
              let totalCost = 0;
              const cartTable = document.getElementById("cart-table");
              const cartBody = cartTable.querySelector("tbody");

              // 获取所有行
              const rows = cartBody.querySelectorAll("tr");
              rows.forEach((row) => {
                const checkbox = row.querySelector(".checkbox");
                const subtotalCell = row.cells[row.cells.length - 2];
                const subtotal = parseFloat(
                  subtotalCell.textContent.replace("NT$", "")
                );

                if (checkbox.checked) {
                  totalCost += subtotal;
                }
              });

              // 更新显示总价的元素
              const totalCostOnPageElement =
                document.querySelector(".totalCostOnPage");
              if (totalCostOnPageElement) {
                totalCostOnPageElement.textContent = `總價: NT$${totalCost}`;
              }
            }

            // 获取选中的商品数据并发送到服务器
            function saveCartToDatabase() {
              const productIds = [];

              // 获取所有行
              const rows = document.querySelectorAll("#cart-table tbody tr");
              rows.forEach((row) => {
                const productId = row
                  .querySelector(".checkbox")
                  .getAttribute("product-id");
                productIds.push(productId);
              });

              // 发送选中的商品数据到服务器
              fetch("/SaveCart", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ product_ids: productIds }),
              })
                .then((response) => response.json())
                .then((data) => {
                  if (data.success) {
                    alert("您的購物車已更新");
                  } else {
                    alert("儲存購物車失敗");
                  }
                })
                .catch((error) => {
                  console.error("Error:", error);
                  alert("儲存購物車時發生錯誤");
                });
            }

            function removeFromCart(product_id) {
              const productId = product_id;
              fetch("/RemoveFromCart", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ product_id: productId }),
              })
                .then((response) => response.json())
                .then((data) => {
                  if (data.success) {
                    if (cart[productId]) {
                      delete cart[productId];
                    }

                    // 将更新后的购物车数据重新设置到cookie中
                    setCartCookie(cart);

                    const rowToRemove = document.getElementById(`row-${productId}`);
                    rowToRemove.remove();
                    updateTotalCost();
                  } else {
                    alert("移除商品失敗");
                  }
                })
                .catch((error) => {
                  console.error("Error:", error);
                  alert("移除商品時發生錯誤");
                });
            }

            function setCartCookie(cart) {
              const cartJSON = JSON.stringify(cart);
              // 未设置max-age属性，该cookie将成为会话cookie
              document.cookie = `cart=${cartJSON}; path=/`;
            }

            const form = document.getElementById("shipping-form");
            // 選擇 "Pay" 按鈕
            const payButton = document.querySelector(".Pay");
            // 選擇模態窗口
            let modal = new bootstrap.Modal(document.getElementById("exampleModal"));

            // 為表單添加 "submit" 事件監聽器
            form.addEventListener("submit", function (event) {
              // 阻止表單的默認提交行為
              event.preventDefault();

              // 使用 `checkValidity()` 檢查表單的有效性
              const isValid = form.checkValidity();

              // 如果表單有效
              if (isValid) {
                // 顯示模態窗口
                modal.show();
              } else {
                // 如果表單無效，調用 `reportValidity()` 顯示錯誤
                form.reportValidity();
              }
            });

            // 获取购物车数据
            /*const clearCart = () => {
              localStorage.removeItem("cartData");
              console.log("购物车数据已清空");
            };*/
            document.addEventListener("DOMContentLoaded", function () {
              // 获取 modal 元素
              const modal = document.getElementById("exampleModal");
              // 如果 modal 不为空，则添加事件监听器
              if (modal) {
                // 监听 modal 隐藏事件
                modal.addEventListener("hidden.bs.modal", function () {
                  // 在 modal 隐藏（关闭）时清空内容
                  clearContents();
                });
              } else {
                console.error("未找到 ID 为 'exampleModal' 的 modal 元素");
              }
            });

            function clearContents() {
              // 从 localStorage 中获取 cartData
              const cartData = JSON.parse(localStorage.getItem("cartData"));

              // 获取当前日期和时间
              const currentDate = new Date();
              const formattedDate = currentDate.toLocaleString(); // 以本地化格式获取日期和时间

              // 清空表格主体的内容
              const tableBody = document.querySelector("#cart-table tbody");
              if (tableBody) {
                tableBody.innerHTML = "";
                console.log("表格主体的内容已清空");
              }

              // 清空 offcanvas-body 的内容
              const offcanvasBody = document.getElementById("offcanvas-body");
              if (offcanvasBody) {
                offcanvasBody.innerHTML = "";
                console.log("offcanvas-body 已清空");
              }

              // 将总价归零
              const totalPriceElement = document.querySelector(".totalCostOnPage");
              if (totalPriceElement) {
                totalPriceElement.textContent = "總價: $0";
                console.log("总价已重置为 0");
              }

              // 清空 shipping-form 表单中的输入字段
              const shippingForm = document.getElementById("shipping-form");
              if (shippingForm) {
                const inputs = shippingForm.querySelectorAll("input");
                inputs.forEach((input) => {
                  input.value = ""; // 将 input 的值设置为空字符串
                });
                console.log("shipping-form 表单中的输入字段已清空");
              }

              // 从 localStorage 中获取现有的购买记录数据
              let purchaseHistory =
                JSON.parse(localStorage.getItem("purchaseHistory")) || [];

              // 如果 cartData 存在且不为空，将购物车内容添加到购买记录中
              if (cartData && cartData.length > 0) {
                // 为每个购物车项添加当前日期和时间
                const cartDataWithDate = cartData.map((item) => {
                  return {
                    ...item,
                    purchaseDate: formattedDate, // 添加购买日期和时间
                  };
                });

                // 将购物车内容添加到购买记录中
                purchaseHistory.push(...cartDataWithDate);
                console.log("购物车内容已添加到购买记录");

                // 清空 cartData 数据
                localStorage.removeItem("cartData");
                console.log("cartData 已清空");
              }

              // 将更新后的购买记录保存回 localStorage
              localStorage.setItem(
                "purchaseHistory",
                JSON.stringify(purchaseHistory)
              );
              console.log("购买记录已保存到 purchaseHistory");

              // 跳转到购买记录页面
              window.location.href = "PurchaseHistory.html";
            }

            // 清空购物车数据
            const clearCart = () => {
              document.cookie.split(";").forEach((cookie) => {
                const name = cookie.split("=")[0].trim();
                if (name.startsWith("cartItem_")) {
                  document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
                }
              });
              console.log("购物车数据已清空");
            };
    </script>
  </body>
</html>
